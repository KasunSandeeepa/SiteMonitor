<!DOCTYPE html>
<html>
<head>
    <title>Website Performance Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-weight: 600;
            color: #333;
            margin-bottom: 40px;
        }

        h2 {
            text-align: center;
            font-weight: 500;
            color: #555;
            margin-bottom: 15px;
        }

        .chart-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 60px;
        }

        .chart-box {
            flex: 1 1 45%;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .dropdown-container {
            text-align: center;
            margin-bottom: 15px;
        }

        select.timeframe-dropdown {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        select.timeframe-dropdown:hover {
            border-color: #888;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        select.timeframe-dropdown:focus {
            outline: none;
            border-color: #4f8ef7;
            box-shadow: 0 0 5px rgba(79,142,247,0.5);
        }

        @media (max-width: 900px) {
            .chart-box {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <h1>üåê Website Performance Monitor</h1>

    {% for site in websites %}
        <h2>{{ site }}</h2>
        <div class="dropdown-container">
            <label style="font-weight:500; margin-right:8px;">View:</label>
            <select class="timeframe-dropdown" data-site="{{ site }}">
                <option value="daily">Daily (hourly avg)</option>
                <option value="weekly">Weekly (daily avg)</option>
                <option value="monthly">Monthly (daily avg)</option>
            </select>
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <canvas id="ttfbChart-{{ loop.index }}" width="400" height="200"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="loadChart-{{ loop.index }}" width="400" height="200"></canvas>
            </div>
        </div>
    {% endfor %}

    <script>
        const sites = {{ websites|tojson }};
        const ttfbCharts = [];
        const loadCharts = [];

        // Parse timestamp as local time
        function parseLocalDateTime(ts) {
            const [datePart, timePart] = ts.split(" ");
            const [year, month, day] = datePart.split("-").map(Number);
            const [hour, minute, second] = timePart.split(":").map(Number);
            return new Date(year, month-1, day, hour, minute, second);
        }

        // Aggregate data per timeframe
        function processData(data, timeframe) {
            const map = {};
            const result = { labels: [], ttfb: [], load: [] };

            data.forEach(d => {
                const dt = parseLocalDateTime(d.time);
                let key;

                if (timeframe === "daily") {
                    key = dt.getHours() + ":00";
                } else if (timeframe === "weekly" || timeframe === "monthly") {
                    key = dt.toISOString().slice(0,10); // YYYY-MM-DD
                }

                if (!map[key]) map[key] = { ttfbSum: 0, loadSum: 0, count: 0 };
                map[key].ttfbSum += d.ttfb;
                map[key].loadSum += d.loading_delay;
                map[key].count += 1;
            });

            for (const key of Object.keys(map).sort()) {
                result.labels.push(key);
                result.ttfb.push(map[key].ttfbSum / map[key].count);
                result.load.push(map[key].loadSum / map[key].count);
            }

            return result;
        }

        // Fetch data and update charts
        function updateCharts(index, site, timeframe) {
            fetch(`/api/data/${encodeURIComponent(site)}`)
                .then(res => res.json())
                .then(data => {
                    const processed = processData(data, timeframe);

                    ttfbCharts[index].data.labels = processed.labels;
                    ttfbCharts[index].data.datasets[0].data = processed.ttfb;
                    ttfbCharts[index].update();

                    loadCharts[index].data.labels = processed.labels;
                    loadCharts[index].data.datasets[0].data = processed.load;
                    loadCharts[index].update();
                })
                .catch(err => console.error("Error fetching data for", site, err));
        }

        // Initialize charts
        sites.forEach((site, index) => {
            ttfbCharts[index] = new Chart(document.getElementById(`ttfbChart-${index+1}`), {
                type: "line",
                data: { labels: [], datasets: [{ label: "TTFB (s)", data: [], borderColor: "#4f8ef7", backgroundColor: "rgba(79,142,247,0.2)", tension: 0.3, fill: true }] }
            });

            loadCharts[index] = new Chart(document.getElementById(`loadChart-${index+1}`), {
                type: "line",
                data: { labels: [], datasets: [{ label: "Full Page Load (s)", data: [], borderColor: "#f75f4f", backgroundColor: "rgba(247,95,79,0.2)", tension: 0.3, fill: true }] }
            });

            // Initial chart load (daily view)
            updateCharts(index, site, "daily");
        });

        // Dropdown listener
        document.querySelectorAll(".timeframe-dropdown").forEach((dropdown, index) => {
            dropdown.addEventListener("change", () => {
                const timeframe = dropdown.value;
                const site = dropdown.dataset.site;
                updateCharts(index, site, timeframe);
            });
        });

        // Auto-refresh charts every 60 seconds
        function refreshAllCharts() {
            sites.forEach((site, index) => {
                const dropdown = document.querySelector(`select[data-site="${site}"]`);
                const timeframe = dropdown.value;
                updateCharts(index, site, timeframe);
            });
        }

        setInterval(refreshAllCharts, 60000);
    </script>
</body>
</html>
